<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nguyen Bao Thu Phuong">
<meta name="dcterms.date" content="2024-09-21">

<title>ISSS626-GAA - Take-home Exercise 1: Geospatial Analytics for Public Good</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ISSS626-GAA</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Hands-on Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercise">    
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01/Hands-on_Ex011.html">
 <span class="dropdown-text">1.1 - Geospatial Data Wrangling with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01/Hands-on_Ex012.html">
 <span class="dropdown-text">1.2 - Choropleth Mapping with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02/Hands-on_Ex021.html">
 <span class="dropdown-text">2.1 - 1st Order Spatial Point Patterns Analysis Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02/Hands-on_Ex022.html">
 <span class="dropdown-text">2.2 - 2nd Order Spatial Point Patterns Analysis Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex03/Hands-on_Ex031.html">
 <span class="dropdown-text">3.1 - Network Constrained Spatial Point Patterns Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex04/Hands-on_Ex041.html">
 <span class="dropdown-text">4.1 - Spatial Weights and Applications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05/Hands-on_Ex051.html">
 <span class="dropdown-text">5.1 - Global Measures of Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05/Hands-on_Ex052.html">
 <span class="dropdown-text">5.2 - Local Measures of Spatial Autocorrelation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">In-class Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercise">    
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex01/In-class_Ex01.html">
 <span class="dropdown-text">1 - Geospatial Data Analysis with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex02/In-class_Ex02.html">
 <span class="dropdown-text">2 - Spatial Point Pattern Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex03/In-class_Ex03.html">
 <span class="dropdown-text">3 - Network Constrained Spatial Point Patterns Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex04/In-class_Ex04.html">
 <span class="dropdown-text">4 - Geographically Weighted Summary Statistics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Take-home Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercise">    
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex01/Take-home_Ex01.html">
 <span class="dropdown-text">1 - Geospatial Analytics for Public Good</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/nguyenbaothuphuong/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" style="font-size: 2em;" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#setting-the-scene" id="toc-setting-the-scene" class="nav-link" data-scroll-target="#setting-the-scene"><span class="header-section-number">1.1</span> Setting the scene</a></li>
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives"><span class="header-section-number">1.2</span> Objectives</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><span class="header-section-number">1.3</span> The Data</a></li>
  </ul></li>
  <li><a href="#set-up-r-environment" id="toc-set-up-r-environment" class="nav-link" data-scroll-target="#set-up-r-environment"><span class="header-section-number">2</span> Set up R environment</a></li>
  <li><a href="#spatial-data-wrangling" id="toc-spatial-data-wrangling" class="nav-link" data-scroll-target="#spatial-data-wrangling"><span class="header-section-number">3</span> Spatial Data Wrangling</a>
  <ul class="collapse">
  <li><a href="#data-import-and-preparation" id="toc-data-import-and-preparation" class="nav-link" data-scroll-target="#data-import-and-preparation"><span class="header-section-number">3.1</span> Data Import and Preparation</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">3.2</span> Data Wrangling</a></li>
  </ul></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">4</span> Exploratory Data Analysis</a>
  <ul class="collapse">
  <li><a href="#visualize-the-geospatial-data" id="toc-visualize-the-geospatial-data" class="nav-link" data-scroll-target="#visualize-the-geospatial-data"><span class="header-section-number">4.1</span> Visualize the Geospatial Data</a></li>
  <li><a href="#visualize-traffic-accidents-data" id="toc-visualize-traffic-accidents-data" class="nav-link" data-scroll-target="#visualize-traffic-accidents-data"><span class="header-section-number">4.2</span> Visualize Traffic Accidents Data</a></li>
  </ul></li>
  <li><a href="#spatio-temporal-point-pattern-analysis" id="toc-spatio-temporal-point-pattern-analysis" class="nav-link" data-scroll-target="#spatio-temporal-point-pattern-analysis"><span class="header-section-number">5</span> Spatio-Temporal Point Pattern Analysis</a>
  <ul class="collapse">
  <li><a href="#visualize-geographic-distribution-of-traffic-accident-by-month" id="toc-visualize-geographic-distribution-of-traffic-accident-by-month" class="nav-link" data-scroll-target="#visualize-geographic-distribution-of-traffic-accident-by-month"><span class="header-section-number">5.1</span> Visualize geographic distribution of traffic accident by month</a></li>
  <li><a href="#compute-stkde-for-different-time-dimensions" id="toc-compute-stkde-for-different-time-dimensions" class="nav-link" data-scroll-target="#compute-stkde-for-different-time-dimensions"><span class="header-section-number">5.2</span> Compute STKDE for different time dimensions</a></li>
  </ul></li>
  <li><a href="#network-spatial-point-patterns-analysis" id="toc-network-spatial-point-patterns-analysis" class="nav-link" data-scroll-target="#network-spatial-point-patterns-analysis"><span class="header-section-number">6</span> Network Spatial Point Patterns Analysis</a>
  <ul class="collapse">
  <li><a href="#prepare-the-lixels-objects-and-generate-line-centre-points" id="toc-prepare-the-lixels-objects-and-generate-line-centre-points" class="nav-link" data-scroll-target="#prepare-the-lixels-objects-and-generate-line-centre-points"><span class="header-section-number">6.1</span> Prepare the lixels objects and generate line centre points</a></li>
  <li><a href="#perform-nkde" id="toc-perform-nkde" class="nav-link" data-scroll-target="#perform-nkde"><span class="header-section-number">6.2</span> Perform NKDE</a></li>
  <li><a href="#network-constrained-g--and-k-function-analysis" id="toc-network-constrained-g--and-k-function-analysis" class="nav-link" data-scroll-target="#network-constrained-g--and-k-function-analysis"><span class="header-section-number">6.3</span> Network Constrained G- and K-Function Analysis</a></li>
  <li><a href="#analyze-accidents-at-high-nkde-lixels" id="toc-analyze-accidents-at-high-nkde-lixels" class="nav-link" data-scroll-target="#analyze-accidents-at-high-nkde-lixels"><span class="header-section-number">6.4</span> Analyze Accidents at high NKDE lixels</a>
  <ul class="collapse">
  <li><a href="#environmental-factors" id="toc-environmental-factors" class="nav-link" data-scroll-target="#environmental-factors"><span class="header-section-number">6.4.1</span> Environmental Factors</a></li>
  <li><a href="#behavioural-factors" id="toc-behavioural-factors" class="nav-link" data-scroll-target="#behavioural-factors"><span class="header-section-number">6.4.2</span> Behavioural Factors</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#temporal-network-spatial-point-pattern-analysis" id="toc-temporal-network-spatial-point-pattern-analysis" class="nav-link" data-scroll-target="#temporal-network-spatial-point-pattern-analysis"><span class="header-section-number">7</span> Temporal Network Spatial Point Pattern Analysis</a>
  <ul class="collapse">
  <li><a href="#temporal-dimension" id="toc-temporal-dimension" class="nav-link" data-scroll-target="#temporal-dimension"><span class="header-section-number">7.1</span> Temporal Dimension</a></li>
  <li><a href="#spatial-temporal-bandwidth-selection" id="toc-spatial-temporal-bandwidth-selection" class="nav-link" data-scroll-target="#spatial-temporal-bandwidth-selection"><span class="header-section-number">7.2</span> Spatial Temporal Bandwidth Selection</a></li>
  <li><a href="#perform-temporal-network-kernel-density-estimate-tnkde" id="toc-perform-temporal-network-kernel-density-estimate-tnkde" class="nav-link" data-scroll-target="#perform-temporal-network-kernel-density-estimate-tnkde"><span class="header-section-number">7.3</span> Perform Temporal Network Kernel Density Estimate (TNKDE)</a></li>
  </ul></li>
  <li><a href="#conclusions-and-future-improvements" id="toc-conclusions-and-future-improvements" class="nav-link" data-scroll-target="#conclusions-and-future-improvements"><span class="header-section-number">8</span> Conclusions and Future Improvements</a>
  <ul class="collapse">
  <li><a href="#factors-affecting-traffic-accidents" id="toc-factors-affecting-traffic-accidents" class="nav-link" data-scroll-target="#factors-affecting-traffic-accidents"><span class="header-section-number">8.1</span> Factors affecting Traffic Accidents</a></li>
  <li><a href="#future-improvement" id="toc-future-improvement" class="nav-link" data-scroll-target="#future-improvement"><span class="header-section-number">8.2</span> Future Improvement</a></li>
  </ul></li>
  <li><a href="#reference" id="toc-reference" class="nav-link" data-scroll-target="#reference"><span class="header-section-number">9</span> Reference</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Take-home Exercise 1: Geospatial Analytics for Public Good</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nguyen Bao Thu Phuong </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 21, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">September 21, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<section id="setting-the-scene" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="setting-the-scene"><span class="header-section-number">1.1</span> Setting the scene</h2>
<p>According to the World Health Organization (WHO) report, road traffic accidents cause 1.19 million deaths annually, with most fatalities occurring in low- and middle-income countries. Vulnerable road users, including pedestrians and motorcyclists, account for over half of these deaths, and road injuries are the leading cause of death for ages 5–29. The economic impact is severe, costing countries 3% of their GDP.</p>
<p>Thailand’s roads are the deadliest in Southeast Asia, with about 20,000 deaths annually. Between 2014 and 2021, Thailand saw a notable rise in accident frequencies. 19% of all accidents occurs on national highways, with most accidents happening on straight roads and at intersections.</p>
</section>
<section id="objectives" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="objectives"><span class="header-section-number">1.2</span> Objectives</h2>
<p>Road traffic accidents are largely influenced by behavioral factors (driver behavior and performance) and environmental factors (weather and road conditions). While studies using Spatial Point Patterns Analysis (SPPA) have explored these factors, they often overlook temporal elements like season, day in the week, or time during the day.</p>
<p>This study will focus on discovering factors affecting road traffic accidents in the Bangkok Metropolitan Region (BMR) - one of the most populated metropolitan regions in Thailand, using different spatio-temporal point pattern analysis techniques:</p>
<ul>
<li><p>Visualize the spatio-temporal dynamics of traffic accidents in BMR using appropriate statistical graphics and geovisualization methods.</p></li>
<li><p>Perform spatial analysis of traffic accidents using appropriate Network Spatial Point Patterns Analysis methods.</p></li>
<li><p>Conduct spatio-temporal analysis using appropriate Temporal Network Spatial Point Patterns Analysis methods.</p></li>
</ul>
</section>
<section id="the-data" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="the-data"><span class="header-section-number">1.3</span> The Data</h2>
<p>For the purpose of this study, 3 data sets are used:</p>
<ul>
<li><p><a href="https://www.kaggle.com/datasets/thaweewatboy/thailand-road-accident-2019-2022">Thailand Road Accident [2019-2022]</a> on Kaggle: provides statistics on recorded accidents in Thailand from 2019 to 2022. This dataset is in csv format.</p></li>
<li><p><a href="https://data.humdata.org/dataset/hotosm_tha_roads">Thailand Roads (OpenStreetMap Export)</a> on HDX: road network in Thailand in ESRI shapefile format.</p></li>
<li><p><a href="https://data.humdata.org/dataset/cod-ab-tha?">Thailand - Subnational Administrative Boundaries</a> on HDX: boundaries at different administrative levels in Thailand in ESRI shapefile format.</p></li>
</ul>
<p>All these dataset should be downloaded and store in <code>data/rawdata</code> folder under the same folder path with the Quarto document.</p>
</section>
</section>
<section id="set-up-r-environment" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Set up R environment</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Import R packages</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Set Seed</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>The below code chunk uses <code>p_load()</code> of pacman package to install and load relevant packages into R environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf,raster, spatstat, tmap, tidyverse, spNetwork, sparr, RColorBrewer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><a href="https://cran.r-project.org/web/packages/tmap/">tmap</a> for visualizing geospatial data</p></li>
<li><p><a href="https://r-spatial.github.io/sf/">sf</a> for handling geospatial data</p></li>
<li><p><a href="https://www.tidyverse.org/">tidyverse</a> for handling aspatial data</p></li>
<li><p><a href="https://rspatial.org/raster/">raster</a>&nbsp;for handling raster data</p></li>
<li><p><a href="https://cran.r-project.org/web/packages/spatstat/index.html">spatstat</a> for performing Spatial Point Patterns Analysis</p></li>
<li><p><a href="https://tilmandavies.github.io/sparr/index.html">sparr</a> provides functions to estimate fixed and adaptive kernel-smoothed spatial relative risk surfaces via the density-ratio method and perform subsequent inference.</p></li>
<li><p><a href="https://cran.r-project.org/web/packages/spNetwork/index.html">spNetwork</a> provides functions to perform Temporal-Spatial Point Patterns Analysis such as kernel density estimation (KDE) and K-function on network.</p></li>
</ul>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>We set the seed to ensure reproducibility and consistency of the remaining analysis and simulations to be done in this study.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="spatial-data-wrangling" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Spatial Data Wrangling</h1>
<section id="data-import-and-preparation" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="data-import-and-preparation"><span class="header-section-number">3.1</span> Data Import and Preparation</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Traffic Accident</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Thailand Subnational Administrative Boundaries</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Thailand Bangkok Metropolitan Region Road</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>The below code chunk carries out these transformation steps on <code>thai_road_accident_2019_2022.csv</code>:</p>
<ul>
<li><p>read_csv(): import csv file and assign data to a tibble data frame.</p></li>
<li><p>select(): select relevant columns from the tibble data frame</p></li>
<li><p>filter(): exclude records with invalid longitude or latitude value</p></li>
<li><p>mutate(): create additional month/day/time columns from <code>incident_datetime</code></p></li>
<li><p>st_as_sf(): convert tible data frame into simple feature data frame</p></li>
<li><p>st_transform(): reprojected the sf data frame to Thailand Projected coordinate system. EPSG is referred from <a href="https://epsg.io/32647">epsg.io</a>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"data/rawdata/thai_road_accident_2019_2022.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"province_th"</span>, <span class="st">"route"</span>, <span class="st">"report_datetime"</span>,<span class="st">"agency"</span>)) <span class="sc">%&gt;%</span> <span class="co"># remove irrelevant columns</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude) <span class="sc">&amp;</span> longitude <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(latitude) <span class="sc">&amp;</span> latitude <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_no =</span> <span class="fu">month</span>(incident_datetime)) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_fac =</span> <span class="fu">month</span>(incident_datetime,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dayofweek =</span> <span class="fu">wday</span>(incident_datetime, <span class="at">week_start =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dayofyear =</span> <span class="fu">yday</span>(incident_datetime)) <span class="sc">%&gt;%</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hourofday =</span> <span class="fu">hour</span>(incident_datetime)) <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(incident_datetime)) <span class="sc">%&gt;%</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">32647</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we write the result sf data frame to rds format to avoid repeating the initial transformations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(rdacc_sf, <span class="st">"data/rds/acc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The below code chunk uses <code>read_rds()</code> to read in the rds file and filter for accidents in Bangkok Metropolitan Region. The output is assigned to <code>bmr_acc</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">=</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/acc.rds"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(province_en <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bangkok"</span>,<span class="st">"Nakhon Pathom"</span>, <span class="st">"Pathum Thani"</span>,<span class="st">"Nonthaburi"</span>, <span class="st">"Samut Prakan"</span>, <span class="st">"Samut Sakhon"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we check the content and CRS of the simple features object and observe the following:</p>
<ul>
<li><p>The event object <code>bmr_acc</code> is already in POINT geometry type with dimension XY, which satisfies the requirement for further Kernel Density Estimate (KDE) analysis.</p></li>
<li><p>CRS is set to EPSG 32647 as expected.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bmr_acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 12986 features and 18 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 12,986 × 19
   acc_code incident_datetime   province_en   vehicle_type        presumed_cause
 *    &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;         &lt;chr&gt;               &lt;chr&gt;         
 1   571882 2019-01-01 02:25:00 Nakhon Pathom motorcycle          speeding      
 2   600001 2019-01-01 03:00:00 Nonthaburi    private/passenger … speeding      
 3   605043 2019-01-01 03:00:00 Samut Prakan  private/passenger … running red l…
 4   629691 2019-01-01 03:05:00 Bangkok       other               other         
 5   571887 2019-01-01 04:30:00 Nakhon Pathom motorcycle          speeding      
 6   599234 2019-01-01 04:45:00 Samut Prakan  motorcycle          driving under…
 7   599990 2019-01-01 05:30:00 Samut Sakhon  motorcycle          speeding      
 8   612045 2019-01-01 05:30:00 Nonthaburi    private/passenger … cutting in cl…
 9   629689 2019-01-01 05:42:00 Bangkok       other               other         
10   607046 2019-01-01 06:30:00 Pathum Thani  private/passenger … speeding      
# ℹ 12,976 more rows
# ℹ 14 more variables: accident_type &lt;chr&gt;, number_of_vehicles_involved &lt;dbl&gt;,
#   number_of_fatalities &lt;dbl&gt;, number_of_injuries &lt;dbl&gt;,
#   weather_condition &lt;chr&gt;, road_description &lt;chr&gt;, slope_description &lt;chr&gt;,
#   month_no &lt;dbl&gt;, month_fac &lt;ord&gt;, dayofweek &lt;dbl&gt;, dayofyear &lt;dbl&gt;,
#   hourofday &lt;int&gt;, year &lt;dbl&gt;, geometry &lt;POINT [m]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(bmr_acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: EPSG:32647 
  wkt:
PROJCRS["WGS 84 / UTM zone 47N",
    BASEGEOGCRS["WGS 84",
        ENSEMBLE["World Geodetic System 1984 ensemble",
            MEMBER["World Geodetic System 1984 (Transit)"],
            MEMBER["World Geodetic System 1984 (G730)"],
            MEMBER["World Geodetic System 1984 (G873)"],
            MEMBER["World Geodetic System 1984 (G1150)"],
            MEMBER["World Geodetic System 1984 (G1674)"],
            MEMBER["World Geodetic System 1984 (G1762)"],
            MEMBER["World Geodetic System 1984 (G2139)"],
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]],
            ENSEMBLEACCURACY[2.0]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 47N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",99,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Navigation and medium accuracy spatial referencing."],
        AREA["Between 96°E and 102°E, northern hemisphere between equator and 84°N, onshore and offshore. China. Indonesia. Laos. Malaysia - West Malaysia. Mongolia. Myanmar (Burma). Russian Federation. Thailand."],
        BBOX[0,96,84,102]],
    ID["EPSG",32647]]</code></pre>
</div>
</div>
<p>We check if the data contains any duplicated accident records. The return index is 0 indicates there is no duplicated records.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyDuplicated</span>(bmr_acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>As the <code>Thailand Roads</code> shapefile from OpenStreetMap contains various road types in Thailand, we visualize the frequency of accidents involving different vehicle types to decide which road types to be included for the scope of this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> bmr_acc, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(vehicle_type))) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span>  <span class="co"># Bar plot with colored bars</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Frequency of Different Vehicle Types"</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Vehicle Type"</span>, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above chart shows that the majority of the accidents were caused by motor vehicles, only 0.39 % were caused by bicycle, pedestrian, motorized tricycle and agricultural vehicle as calculated below.</p>
<p>For the scope of this analysis, we will focus on motor vehicles related accident and road types that allow motor vehicles access only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the records where vehicle_type is either 'pedestrian' or 'bicycle'</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>subset_vehicle <span class="ot">&lt;-</span> bmr_acc[bmr_acc<span class="sc">$</span>vehicle_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"pedestrian"</span>, <span class="st">"bicycle"</span>,<span class="st">"motorized tricycle"</span>,<span class="st">"tractor/agricultural vehicle"</span>), ]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage &amp; print the result</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>percentage <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(subset_vehicle) <span class="sc">/</span> <span class="fu">nrow</span>(bmr_acc)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Percentage of pedestrian and bicycle records:"</span>, <span class="fu">round</span>(percentage, <span class="dv">2</span>), <span class="st">"%"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Percentage of pedestrian and bicycle records: 0.39 %"</code></pre>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>The below code chunk uses st_read() to imports the administrative boundaries at province level (level 1) and filter for provinces in Bangkok Metropolitan Region.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>bmr_prov <span class="ot">=</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/rawdata"</span>,<span class="at">layer =</span> <span class="st">"tha_admbnda_adm1_rtsd_20220121"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ADM1_EN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bangkok"</span>,<span class="st">"Nakhon Pathom"</span>, <span class="st">"Pathum Thani"</span>,<span class="st">"Nonthaburi"</span>, <span class="st">"Samut Prakan"</span>, <span class="st">"Samut Sakhon"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output is written to rds file to avoid repeating initial transformation steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(bmr_prov, <span class="st">"data/rds/bmr_prov.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we read from rds file using <code>read_rds()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bmr_prov <span class="ot">=</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/bmr_prov.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and reproject to Thailand projected coordinate system using <code>st_transform()</code>. The output is assigned to <code>bmr_boundary</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bmr_boundary <span class="ot">=</span> <span class="fu">st_transform</span>(bmr_prov, <span class="at">crs =</span> <span class="dv">32647</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking the content and CRS of this sf data frame yields the below:</p>
<ul>
<li><p>The event object <code>bmr_boundary</code> is in POLYGON geometry type with dimension XY, which is as expected for boundary object.</p></li>
<li><p>CRS is set to EPSG 32647 as expected.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>bmr_boundary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 16 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 587893.5 ymin: 1484414 xmax: 712440.5 ymax: 1579076
Projected CRS: WGS 84 / UTM zone 47N
  Shape_Leng Shape_Area       ADM1_EN      ADM1_TH ADM1_PCODE ADM1_REF
1   2.417227 0.13133873       Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
2   1.695100 0.07926199  Samut Prakan   สมุทรปราการ       TH11     &lt;NA&gt;
3   1.251111 0.05323766    Nonthaburi        นนทบุรี       TH12     &lt;NA&gt;
4   1.884945 0.12698345  Pathum Thani       ปทุมธานี       TH13     &lt;NA&gt;
5   2.463030 0.17891420 Nakhon Pathom       นครปฐม       TH73     &lt;NA&gt;
6   1.566369 0.07155983  Samut Sakhon     สมุทรสาคร       TH74     &lt;NA&gt;
  ADM1ALT1EN ADM1ALT2EN ADM1ALT1TH ADM1ALT2TH  ADM0_EN   ADM0_TH ADM0_PCODE
1       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
2       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
3       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
4       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
5       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
6       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
        date    validOn    validTo                       geometry
1 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((674339.8 15...
2 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((687139.8 15...
3 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((644817.9 15...
4 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((704086 1575...
5 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((631987.6 15...
6 2019-02-18 2022-01-22 -001-11-30 MULTIPOLYGON (((641549.1 15...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(bmr_boundary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: EPSG:32647 
  wkt:
PROJCRS["WGS 84 / UTM zone 47N",
    BASEGEOGCRS["WGS 84",
        ENSEMBLE["World Geodetic System 1984 ensemble",
            MEMBER["World Geodetic System 1984 (Transit)"],
            MEMBER["World Geodetic System 1984 (G730)"],
            MEMBER["World Geodetic System 1984 (G873)"],
            MEMBER["World Geodetic System 1984 (G1150)"],
            MEMBER["World Geodetic System 1984 (G1674)"],
            MEMBER["World Geodetic System 1984 (G1762)"],
            MEMBER["World Geodetic System 1984 (G2139)"],
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]],
            ENSEMBLEACCURACY[2.0]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 47N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",99,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Navigation and medium accuracy spatial referencing."],
        AREA["Between 96°E and 102°E, northern hemisphere between equator and 84°N, onshore and offshore. China. Indonesia. Laos. Malaysia - West Malaysia. Mongolia. Myanmar (Burma). Russian Federation. Thailand."],
        BBOX[0,96,84,102]],
    ID["EPSG",32647]]</code></pre>
</div>
</div>
<p>We use <strong>tmap</strong> to plot the output and can see the 6 provinces of BMR has been plotted correctly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_text</span>(<span class="st">"ADM1_EN"</span>, <span class="at">size =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>The below code chunk carries out the following steps:</p>
<ul>
<li><p><code>st_read()</code>: read in the shapefile exported from OpenStreetMap</p></li>
<li><p><code>st_set_crs()</code>: as the original datataset CRS is NA, we use st_set_crs() to assign to EPSG 4326 of WGS84 geodetic coordinate system</p></li>
<li><p><code>st_intersection()</code>: filter for roads inside BMR boundary only.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>bmr_road <span class="ot">=</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/rawdata"</span>,<span class="at">layer =</span> <span class="st">"hotosm_tha_roads_lines_shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(bmr_prov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We write the output into rds file using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(bmr_road, <span class="st">"data/rds/bmr_road.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As the OSM data include exhaustive road types (under column <code>highway</code>), we will filter for road types that allow motor vehicles access only. According to <a href="https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification">WikiProject Thailand</a>, we filter for the below <code>highway</code> classification where motorcycle and car can access.</p>
<p>The below code chunk uses:</p>
<ul>
<li><p><code>read_rds()</code> to read from rds file</p></li>
<li><p><code>filter()</code>: filter for relevant road types</p></li>
<li><p><code>st_transform()</code>: reproject to Thailand Projected CRS.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>bmr_road_ft <span class="ot">=</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/bmr_road.rds"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(highway <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"motorway"</span>, <span class="st">"motorway_link"</span>, <span class="st">"trunk"</span>,<span class="st">"trunk_link"</span>,<span class="st">"primary"</span>,<span class="st">"primary_link"</span>,<span class="st">"secondary"</span>,<span class="st">"secondary_link"</span>,<span class="st">"tertiary"</span>,<span class="st">"tertiary_link"</span>, <span class="st">"unclassified"</span>,<span class="st">"living_street"</span>, <span class="st">"road"</span>, <span class="st">"residential"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">32647</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We rrite the transformed road data to rds file using <code>write_rds()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(bmr_road_ft, <span class="st">"data/rds/network.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we read from rds file using <code>read_rds()</code> and assigned the output to <code>network</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">=</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/network.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use <code>tm_shape()</code> and <code>tm_lines()</code> to plot the road network for a quick view.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(network) <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The network is still too dense to be observable. The frequency of different <code>highway</code> classification is plotted as below for further investigation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> network, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(highway))) <span class="sc">+</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span>  <span class="co"># Bar plot with colored bars</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Frequency of Different Highway Classes"</span>, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Highway Class"</span>, </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It can be seen that <code>residential</code> class takes up the majority number of records. As defined in <a href="https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification">WikiProject Thailand</a>, <code>residential</code> class includes roads “within a residential area that gives the public access to one or multiple residences. Also used for roads within a gated housing estate (add access=private). Residential roads are typically short in length and often named.” As these roads are inside residential area and usually short, we assume the number of traffic accidents happening on this type of road is small.</p>
<p>We exclude <code>highway=residential</code> from the <code>network</code> sf object using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">=</span> <span class="fu">filter</span>(network, <span class="sc">!</span> highway <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"residential"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking the content and CRS of <code>network</code> sf data frame yields the below:</p>
<ul>
<li><p>The object is in GEOMETRY geometry type with dimension XY, while NKDE analysis requires LINESTRING geometry type.</p></li>
<li><p>CRS is set to EPSG 32647 as expected.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 33100 features and 30 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 590124.8 ymin: 1484506 xmax: 712235 ymax: 1579041
Projected CRS: WGS 84 / UTM zone 47N
First 10 features:
                 name                name_en        highway  surface smoothness
1          ถนนฉลองกรุง     Chalong Krung Road      secondary    paved       &lt;NA&gt;
3                &lt;NA&gt;                   &lt;NA&gt; secondary_link     &lt;NA&gt;       &lt;NA&gt;
5          ถนนฉลองกรุง     Chalong Krung Road      secondary concrete       &lt;NA&gt;
869  ถนนประชาสงเคราะห์   Pracha Songkhro Road       tertiary  asphalt       &lt;NA&gt;
1030             &lt;NA&gt;                   &lt;NA&gt; secondary_link     &lt;NA&gt;       &lt;NA&gt;
1099     ถนนวิภาวดีรังสิต Vibhavadi Rangsit Road      secondary     &lt;NA&gt;       &lt;NA&gt;
1101         ถนนดินแดง         Din Daeng Road        primary     &lt;NA&gt;       &lt;NA&gt;
1104     ถนนวิภาวดีรังสิต Vibhavadi Rangsit Road      secondary     &lt;NA&gt;       &lt;NA&gt;
1106         ถนนดินแดง         Din Daeng Road        primary     &lt;NA&gt;       &lt;NA&gt;
1108             &lt;NA&gt;                   &lt;NA&gt;   primary_link     &lt;NA&gt;       &lt;NA&gt;
     width lanes oneway bridge layer source          name_th     osm_id
1     &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;       ถนนฉลองกรุง 1125681229
3     &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;             &lt;NA&gt;  472283206
5     &lt;NA&gt;     2    yes    yes     1   Bing       ถนนฉลองกรุง  116847248
869   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt; ถนนประชาสงเคราะห์   25933535
1030  &lt;NA&gt;  &lt;NA&gt;    yes    yes     1   Bing             &lt;NA&gt;   97092142
1099  &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;     ถนนวิภาวดีรังสิต  835519345
1101  &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;         ถนนดินแดง 1055365750
1104  &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;     ถนนวิภาวดีรังสิต 1306889182
1106  &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;         ถนนดินแดง 1306889184
1108  &lt;NA&gt;  &lt;NA&gt;    yes   &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;             &lt;NA&gt; 1306889186
      osm_type Shape_Leng Shape_Area ADM1_EN      ADM1_TH ADM1_PCODE ADM1_REF
1    ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
3    ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
5    ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
869  ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1030 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1099 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1101 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1104 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1106 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
1108 ways_line   2.417227  0.1313387 Bangkok กรุงเทพมหานคร       TH10     &lt;NA&gt;
     ADM1ALT1EN ADM1ALT2EN ADM1ALT1TH ADM1ALT2TH  ADM0_EN   ADM0_TH ADM0_PCODE
1          &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
3          &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
5          &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
869        &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1030       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1099       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1101       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1104       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1106       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
1108       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt; Thailand ประเทศไทย         TH
           date    validOn    validTo                       geometry
1    2019-02-18 2022-01-22 -001-11-30 LINESTRING (693686.1 151979...
3    2019-02-18 2022-01-22 -001-11-30 LINESTRING (692949.1 151886...
5    2019-02-18 2022-01-22 -001-11-30 LINESTRING (692810.8 151863...
869  2019-02-18 2022-01-22 -001-11-30 LINESTRING (668360.2 152245...
1030 2019-02-18 2022-01-22 -001-11-30 LINESTRING (652536.6 152423...
1099 2019-02-18 2022-01-22 -001-11-30 LINESTRING (667716.6 152278...
1101 2019-02-18 2022-01-22 -001-11-30 LINESTRING (667485.1 152210...
1104 2019-02-18 2022-01-22 -001-11-30 LINESTRING (667822.4 152298...
1106 2019-02-18 2022-01-22 -001-11-30 LINESTRING (667418.7 152214...
1108 2019-02-18 2022-01-22 -001-11-30 LINESTRING (667434.6 152210...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: EPSG:32647 
  wkt:
PROJCRS["WGS 84 / UTM zone 47N",
    BASEGEOGCRS["WGS 84",
        ENSEMBLE["World Geodetic System 1984 ensemble",
            MEMBER["World Geodetic System 1984 (Transit)"],
            MEMBER["World Geodetic System 1984 (G730)"],
            MEMBER["World Geodetic System 1984 (G873)"],
            MEMBER["World Geodetic System 1984 (G1150)"],
            MEMBER["World Geodetic System 1984 (G1674)"],
            MEMBER["World Geodetic System 1984 (G1762)"],
            MEMBER["World Geodetic System 1984 (G2139)"],
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]],
            ENSEMBLEACCURACY[2.0]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 47N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",99,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Navigation and medium accuracy spatial referencing."],
        AREA["Between 96°E and 102°E, northern hemisphere between equator and 84°N, onshore and offshore. China. Indonesia. Laos. Malaysia - West Malaysia. Mongolia. Myanmar (Burma). Russian Federation. Thailand."],
        BBOX[0,96,84,102]],
    ID["EPSG",32647]]</code></pre>
</div>
</div>
<p>The below code chunk converts the the geometry type to LINESTRING using <code>st_cast()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">=</span> <span class="fu">st_cast</span>(network, <span class="st">"LINESTRING"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We check if data contains any duplicated record using <code>anyDuplicated()</code> . The return index is 0 indicating there is no duplicated records in <code>network</code> sf data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyDuplicated</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="data-wrangling" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="data-wrangling"><span class="header-section-number">3.2</span> Data Wrangling</h2>
<p>As stated in the Objective section, road traffic accidents are generally caused by two main factors: <strong>behavioral</strong> and <strong>environmental</strong>. Behavioral factors, which are often the primary cause, can be divided into driver behavior (driving style) and driver performance (driving skills) (Elander, West, &amp; French, 1993). Environmental factors include conditions like poor visibility due to weather (e.g., heavy rain or fog) and hazardous road features such as sharp bends, slippery slopes, or blind spots.</p>
<p>In this section, we perform additional mapping on the columns relevant to these factors in <code>bmr_acc</code> sf data frame.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Accident Presumed Cause</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Accident Weather Condition</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Road and Slope Condition of Accident</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>First we check the frequency of different accident presume causes using below code chunk:</p>
<ul>
<li><p>group_by(): group the records by <code>presumed_cause</code> column</p></li>
<li><p>summarise(): returns 1 row representing the count of records under each presumed cause.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>cause_counts <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(presumed_cause) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>cause_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 40 features and 2 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 40 × 3
   presumed_cause                                count                  geometry
   &lt;chr&gt;                                         &lt;int&gt;            &lt;GEOMETRY [m]&gt;
 1 abrupt lane change                               59 MULTIPOINT ((603057.8 15…
 2 brake/anti-lock brake system failure              7 MULTIPOINT ((665762 1511…
 3 cutting in closely by people/vehicles/animals   621 MULTIPOINT ((595540.6 15…
 4 dangerous curve                                  14 MULTIPOINT ((640057.9 15…
 5 debris/obstruction on the road                   29 MULTIPOINT ((640235.4 15…
 6 disabled vehicle without proper signals           1  POINT (639212.7 1509212)
 7 disabled vehicle without proper signals/signs     3 MULTIPOINT ((654036.8 15…
 8 driving in the wrong lane                         6 MULTIPOINT ((623601.1 14…
 9 driving under the influence of alcohol          118 MULTIPOINT ((607471.8 15…
10 failure to signal enter/exit parking              5 MULTIPOINT ((622165.9 15…
# ℹ 30 more rows</code></pre>
</div>
</div>
<p>As there are many causes with a small counts, the below code chunk is used to map all causes with records count smaller than or equal to 50 to <code>other cause</code> to avoid crowding the visualization with too many insignificant variables later. The modified mapping is save in <code>presumed_cause_rd</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify causes with less than 50 records</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>rare_causes <span class="ot">&lt;-</span> cause_counts <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(count <span class="sc">&lt;=</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(presumed_cause)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Map those rare causes to "other cause"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">presumed_cause_rd =</span> <span class="fu">ifelse</span>(presumed_cause <span class="sc">%in%</span> rare_causes, <span class="st">"other cause"</span>, presumed_cause))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We check the cause count again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>cause_counts_rd <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(presumed_cause_rd) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>cause_counts_rd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 11 features and 2 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 11 × 3
   presumed_cause_rd                             count                  geometry
   &lt;chr&gt;                                         &lt;int&gt;          &lt;MULTIPOINT [m]&gt;
 1 abrupt lane change                               59 ((603057.8 1533623), (63…
 2 cutting in closely by people/vehicles/animals   621 ((595540.6 1542724), (59…
 3 driving under the influence of alcohol          118 ((607471.8 1545956), (61…
 4 falling asleep                                  221 ((597876.3 1547500), (60…
 5 other                                           957 ((624456.5 1494214), (63…
 6 other cause                                     270 ((599469.8 1542071), (60…
 7 running red lights/traffic signals               96 ((610783.1 1530716), (61…
 8 speeding                                      10143 ((593843.8 1550868), (59…
 9 tailgating                                       83 ((622420.1 1491733), (64…
10 unfamiliarity with the route/unskilled drivi…    53 ((591277.5 1545514), (62…
11 vehicle equipment failure                       365 ((606366 1562577), (6066…</code></pre>
</div>
</div>
<p>We can see the individual rare causes are mapped to <code>other cause</code> already.</p>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>First we check the frequency of different weather conditions using below code chunk:</p>
<ul>
<li><p>group_by(): group the records by <code>weather_condition</code> column</p></li>
<li><p>summarise(): returns 1 row representing the count of records under each weather condition.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>weather_counts <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(weather_condition) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>weather_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 2 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 7 × 3
  weather_condition count                                               geometry
  &lt;chr&gt;             &lt;int&gt;                                         &lt;GEOMETRY [m]&gt;
1 clear             11711 MULTIPOINT ((591277.5 1545514), (593843.8 1550868), (…
2 dark                 81 MULTIPOINT ((629588.3 1507077), (644784.6 1533981), (…
3 foggy                 4 MULTIPOINT ((655920.3 1511008), (666583.8 1509141), (…
4 land slide            1                               POINT (666736.7 1509549)
5 natural disaster      1                               POINT (650910.3 1540963)
6 other                22 MULTIPOINT ((639624 1552092), (649315 1550117), (6494…
7 rainy              1166 MULTIPOINT ((604435.1 1525464), (604930.8 1525557), (…</code></pre>
</div>
</div>
<p>We can see that 90% of accidents (over total 12,986 records) happened under <code>clear</code> weather and 7.7% happened under <code>rainy</code> weather. This signifies majority of road accidents in BMR may not be due to weather.</p>
<p>As other weather condition has relative small counts, we map all these conditions to <code>other condition</code> using below code chunk. The modified mapping is saved in <code>weather_rd</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>weather_other <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dark"</span>, <span class="st">"foggy"</span>, <span class="st">"land slide"</span>, <span class="st">"natural disaster"</span>, <span class="st">"other"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Map those rare condition to "other condition"</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weather_rd =</span> <span class="fu">ifelse</span>(weather_condition <span class="sc">%in%</span> weather_other, <span class="st">"other condition"</span>, weather_condition))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the count again</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>weather_counts_rd <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(weather_rd) <span class="sc">%&gt;%</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>())</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>weather_counts_rd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 2 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 3 × 3
  weather_rd      count                                                 geometry
  &lt;chr&gt;           &lt;int&gt;                                         &lt;MULTIPOINT [m]&gt;
1 clear           11711 ((591277.5 1545514), (593843.8 1550868), (595042.2 1550…
2 other condition   109 ((629588.3 1507077), (639624 1552092), (644784.6 153398…
3 rainy            1166 ((604435.1 1525464), (604930.8 1525557), (604978 152556…</code></pre>
</div>
</div>
<p>We can see the remaining conditions are mapped to <code>other condition</code> already.</p>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>First we check the frequency of different road and slope description combination using below code chunk:</p>
<ul>
<li><p>group_by(): group the records by <code>road_descroption</code> and <code>slope_description</code> columns</p></li>
<li><p>summarise(): returns 1 row representing the count of records under each combination.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the occurrences of each road and slope description combination</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>road_counts <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(road_description, slope_description) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'road_description'. You can override using
the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage of occurrences</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>total_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(road_counts<span class="sc">$</span>count)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>road_counts <span class="ot">&lt;-</span> road_counts <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>((count <span class="sc">/</span> total_count) <span class="sc">*</span> <span class="dv">100</span>,<span class="dv">2</span>))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># View the result</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>road_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 19 features and 4 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 19 × 5
   road_description slope_description count                  geometry percentage
 * &lt;chr&gt;            &lt;chr&gt;             &lt;int&gt;          &lt;MULTIPOINT [m]&gt;      &lt;dbl&gt;
 1 connecting to p… other                 8 ((595545.3 1542719), (61…       0.06
 2 connecting to p… other                43 ((606712.6 1557002), (60…       0.33
 3 connecting to s… other                 4 ((646878.1 1550240), (66…       0.03
 4 four-way inters… other                 6 ((616900.4 1556213), (62…       0.05
 5 grade-separated… other               150 ((654173 1525967), (6560…       1.16
 6 merge lane       other                11 ((665780.8 1524036), (66…       0.08
 7 other            other              1004 ((604914.7 1548870), (60…       7.73
 8 roundabout       other                 3 ((614608.3 1523654), (65…       0.02
 9 sharp curve      no slope              9 ((627908.6 1522233), (63…       0.07
10 sharp curve      slope area           32 ((621201.3 1498072), (62…       0.25
11 straight road    no slope          10221 ((591277.5 1545514), (59…      78.7 
12 straight road    other               712 ((603057.8 1533623), (61…       5.48
13 straight road    slope area          151 ((642026.9 1499283), (65…       1.16
14 t-intersection   other                66 ((599469.8 1542071), (61…       0.51
15 u-turn area      other                 5 ((641181.3 1509733), (66…       0.04
16 wide curve       no slope            347 ((605960.9 1537813), (60…       2.67
17 wide curve       other                90 ((655680.3 1506877), (65…       0.69
18 wide curve       slope area           51 ((652382.4 1524279), (65…       0.39
19 y-intersection   other                73 ((629514.6 1526365), (62…       0.56</code></pre>
</div>
</div>
<p>As there are many road and slope condition combination with small counts, we map all these combinations with records count percentage over total number of cases smaller than 1% to <code>other condition</code> keep the focus on the conditions that presented in the majority of the accidents only.</p>
<p>The below code chunk use <code>mutate()</code> to create <code>road_rd</code> column , which has <code>value = other conditions</code> for accidents under conditions with small counts and <code>value = road_description-slope_description</code> otherwise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify conditions with records percentage less than 1%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>rare_conditions <span class="ot">&lt;-</span> road_counts <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(percentage <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">road_condition =</span> <span class="fu">paste</span>(road_description, slope_description, <span class="at">sep =</span> <span class="st">"-"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(road_condition)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Map those rare causes to "other cause"</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">road_condition =</span> <span class="fu">paste</span>(road_description, slope_description, <span class="at">sep =</span> <span class="st">"-"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">road_rd =</span> <span class="fu">ifelse</span>(road_condition <span class="sc">%in%</span> rare_conditions, <span class="st">"other conditions"</span>, road_condition))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We check the count and percentage in <code>road_rd</code> column using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the occurrences of each road and slop description combination</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>road_counts_rd <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(road_rd) <span class="sc">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>())</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage of occurrences</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>total_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(road_counts_rd<span class="sc">$</span>count)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>road_counts_rd <span class="ot">&lt;-</span> road_counts_rd <span class="sc">%&gt;%</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>((count <span class="sc">/</span> total_count) <span class="sc">*</span> <span class="dv">100</span>,<span class="dv">2</span>))</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># View the result</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>road_counts_rd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 3 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 591277.5 ymin: 1486846 xmax: 710166.1 ymax: 1576520
Projected CRS: WGS 84 / UTM zone 47N
# A tibble: 7 × 4
  road_rd                             count                  geometry percentage
* &lt;chr&gt;                               &lt;int&gt;          &lt;MULTIPOINT [m]&gt;      &lt;dbl&gt;
1 grade-separated intersection/ramps…   150 ((654173 1525967), (6560…       1.16
2 other conditions                      401 ((595545.3 1542719), (59…       3.09
3 other-other                          1004 ((604914.7 1548870), (60…       7.73
4 straight road-no slope              10221 ((591277.5 1545514), (59…      78.7 
5 straight road-other                   712 ((603057.8 1533623), (61…       5.48
6 straight road-slope area              151 ((642026.9 1499283), (65…       1.16
7 wide curve-no slope                   347 ((605960.9 1537813), (60…       2.67</code></pre>
</div>
</div>
<p>We can see all the rare combinations have been mapped to <code>other-conditions</code> already.</p>
</div>
</div>
</div>
</section>
</section>
<section id="exploratory-data-analysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Exploratory Data Analysis</h1>
<section id="visualize-the-geospatial-data" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="visualize-the-geospatial-data"><span class="header-section-number">4.1</span> Visualize the Geospatial Data</h2>
<p>First we plot the map of traffic accidents in BMR with overlaying road network using different function of <strong>tmap</strong> package:</p>
<ul>
<li><p>tm_polygons(): plot the area boundaries</p></li>
<li><p>tm_dots(): plot each accident as a red dot (col = ‘red’) on the map</p></li>
<li><p>tm_lines(): plot the lines to represent the road network in BMR</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary) <span class="sc">+</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(bmr_acc) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(network) <span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above map shows most of the accidents points already lie on the network. Although there are a few points still lying off the network, this number is trivial. We can confirm the <code>network</code> sf data frame cover majority of the accident points and can be used for the remaining analysis.</p>
</section>
<section id="visualize-traffic-accidents-data" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="visualize-traffic-accidents-data"><span class="header-section-number">4.2</span> Visualize Traffic Accidents Data</h2>
<p>In this section, we deep dive into traffic accidents data to understand the trend, severity and related cause of traffic accidents in Bangkok Metropolitan Region from 2019 to 2022.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Traffic Accident Trend</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Traffic Accident by Province</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Distance to Nearest Neighbor</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>To understand if there is any seasonal factor impacting occurence of traffic accidents in BMR, the below code chunk is uses <code>ggplot()</code> to plot the monthly traffic accidents trend by month by year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group data by year and month, and count the number of accidents</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>accidents_by_month <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month_no) <span class="sc">%&gt;%</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">num_accidents =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_month, <span class="fu">aes</span>(<span class="at">x =</span> month_no, <span class="at">y =</span> num_accidents, <span class="at">color =</span> <span class="fu">factor</span>(year), <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Month for Each Year"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Month No"</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Year"</span>) <span class="sc">+</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">labels =</span> month.abb) <span class="sc">+</span> <span class="co"># Label months as Jan, Feb, etc.</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can observe some similarities in the trend across the 4 years:</p>
<ul>
<li><p><strong>April</strong> was the month with the highest number of accident in year 2019 and 2021, and second highest in 2022. This may be due to the Songkran festival in April, which is the largest festival in Thailand. The dip in 2020 can be attributed towards travel restriction during Covid.</p></li>
<li><p><strong>February-March</strong> and <strong>May-June</strong> were the months with lower number of accidents throughout the year.</p></li>
<li><p>The number of accidents had an increasing trend from June to <strong>December</strong>.</p></li>
</ul>
<p>As 2022 is the most recent year with available data and the number of accidents shows a concerning increase towards the end of the year, for the scope of this study we will focus on accidents happening in 2022 only.</p>
<p>The below code chunk uses <code>filter()</code> to filter for accidents recorded in 2022.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">=</span> bmr_acc <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>To understand the geopraphic distribution of traffic accidents in BMR, we use <code>ggplot()</code> to plot the number of accidents by province as in below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by province and count the number of accidents</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>accidents_by_province <span class="ot">&lt;-</span> bmr_acc <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(province_en) <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">accident_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column chart</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_province, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(province_en, <span class="sc">-</span>accident_count), <span class="at">y =</span> accident_count)) <span class="sc">+</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> accident_count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span>  <span class="co"># Add data labels</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Province"</span>, </span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Province"</span>, </span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))  <span class="co"># Rotate x-axis labels for readability</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The column chart shows the first 4 provinces already account for 91% of the total number of accidents in 2022. For the remaining analysis we will focus on these 4 provinces only.</p>
<p>The below code chunk filter for these 4 provinces and select the relevant columns using <code>select()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>network <span class="ot">=</span> network <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ADM1_EN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bangkok"</span>, <span class="st">"Pathum Thani"</span>, <span class="st">"Samut Prakan"</span>, <span class="st">"Samut Sakhon"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"name_en"</span>,<span class="st">"highway"</span>,<span class="st">"osm_id"</span>,<span class="st">"ADM1_EN"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same filter is applied for the <code>bmr_acc</code> and <code>bmr_boundary</code> sf dataframe as below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traffic accident data frame</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>bmr_acc <span class="ot">=</span> bmr_acc <span class="sc">|&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(province_en <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bangkok"</span>, <span class="st">"Pathum Thani"</span>, <span class="st">"Samut Prakan"</span>, <span class="st">"Samut Sakhon"</span>))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Region boundaries data frame</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>bmr_boundary <span class="ot">=</span> bmr_boundary <span class="sc">|&gt;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ADM1_EN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Bangkok"</span>, <span class="st">"Pathum Thani"</span>, <span class="st">"Samut Prakan"</span>, <span class="st">"Samut Sakhon"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot the map again using functions of tmap and can see the 2 provinces Nontha Buri and Nakhon Pathom are properly excluded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_acc) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(network) <span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>Now we want to understand the spread of accident points along the network. We snap the points to the network and calculate the distance of each point to its nearest neighbor on the network.</p>
<p>First we aggregate the events that are within 30 meters to each other using <code>aggregate_points()</code>.</p>
<p><strong>Note</strong>: for the distance calculation to work, we need to ensure no point shares the exact same location on the network. Hence the points close to each other needs to be aggregated before proceeding further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>bmr_acc<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>bmr_acc_agg <span class="ot">&lt;-</span> bmr_acc <span class="sc">|&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_points</span>(<span class="dv">30</span> ,<span class="at">weight =</span> <span class="st">"weight"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next the distance of each even to its nearest neighbor on the network is calculated using <code>network_knn()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>knn_dists <span class="ot">&lt;-</span> <span class="fu">network_knn</span>(<span class="at">origins =</span> bmr_acc_agg, </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lines =</span> network, </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k =</span> <span class="dv">1</span>,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxdistance =</span> <span class="dv">2000</span>,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">line_weight =</span> <span class="st">"length"</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plotting the result using <code>ggplot()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> knn_dists<span class="sc">$</span>distances), <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"distance to nearest neighbour (in meters)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 57 rows containing non-finite outside the scale range
(`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above histogram shows that there are a few points that are very far from its nearest neighbor. We remove the records with distance larger than 5000 meters and plot the result again using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>distances <span class="ot">=</span> knn_dists<span class="sc">$</span>distances</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>distance_ft <span class="ot">=</span> distances[distances <span class="sc">&lt;</span> <span class="dv">5000</span>]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the histogram</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> distance_ft), <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Distance to nearest neighbour (in meters)"</span>) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The histogram is right skewed with 85.3% of events (after aggregating events within 30 meters) falls within 1 kilometers from its nearest neighbors. This indicates there are certain hot spots on BMR road <code>network</code> where traffic accidents occur frequently. We will examine these hot spots in the following TNKDE and NKDE analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate percentage of accidents with nearest neighbor distance lower than 1 kilometer over all accidents in 2022</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(distances[distances <span class="sc">&lt;</span> <span class="dv">1000</span>])<span class="sc">/</span><span class="fu">length</span>(distances)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8528873</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="spatio-temporal-point-pattern-analysis" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Spatio-Temporal Point Pattern Analysis</h1>
<p>A <strong>spatio-temporal point process</strong> is a set of points where each point represents the time and location of an event, such as disease incidence, species sightings, or natural disasters. The analysis of these patterns is increasingly important due to the growth of geographically and temporally indexed data. In the past decade, numerous methods for spatio-temporal point pattern analysis have been developed and implemented in R.</p>
<p>We will use the <strong>Spatio-Temporal Kernel Density Estimate</strong> (STKDE) method to understand the spatio-temporal dynamics of road accidents in Thailand across different provinces and time during 2022.</p>
<section id="visualize-geographic-distribution-of-traffic-accident-by-month" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="visualize-geographic-distribution-of-traffic-accident-by-month"><span class="header-section-number">5.1</span> Visualize geographic distribution of traffic accident by month</h2>
<p>As we observe some seasonality in the number of traffic accidents by month in the previous section, we further investigate if there is any difference in the location of those accidents by month.</p>
<p>The below code chunk uses multiple functions of <strong>tmap</strong> to plot the accidents by month. Each accident is represented by a red dot and each province boundary is filled by a different color.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary)<span class="sc">+</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">"ADM1_EN"</span>, <span class="at">palette =</span> <span class="st">'Pastel2'</span>) <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">width =</span> <span class="fl">0.5</span>, <span class="at">height =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(network) <span class="sc">+</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_acc) <span class="sc">+</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">size =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_facets</span>(<span class="at">by=</span><span class="st">"month_fac"</span>, </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">free.coords=</span><span class="cn">FALSE</span>, </span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">drop.units =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above maps show that the locations of accidents resembles almost the same pattern across all the months, with many points clustered in these 3 parts of the road network:</p>
<ul>
<li><p>Center of Bangkok</p></li>
<li><p>Along the vertical road connecting Pathum Thani, Bangkok and Samut Prakan province</p></li>
<li><p>Along the horizontal road connecting Samut Sakhon and Bangkok</p></li>
</ul>
</section>
<section id="compute-stkde-for-different-time-dimensions" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="compute-stkde-for-different-time-dimensions"><span class="header-section-number">5.2</span> Compute STKDE for different time dimensions</h2>
<p>In this section, we explore how to compute STKDE using <code>spattemp.density()</code>of <strong>sparr</strong> package.</p>
<p>As <code>spattemp.density()</code> requires the object in ppp class, first we create an owin object from <code>bmr_boundary</code> to define the observation window for the ppp object using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>acc_owin <span class="ot">&lt;-</span> <span class="fu">as.owin</span>(bmr_boundary)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>acc_owin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>window: polygonal boundary
enclosing rectangle: [611104.4, 712440.5] x [1484413.7, 1579076.3] units</code></pre>
</div>
</div>
<p>Next, <code>class()</code> of base R is used to confirm if the output is indeed an owin object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(acc_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "owin"</code></pre>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Compute STKDE by month</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Compute STKDE by day of week</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">Compute STKDE by hour of day</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<section id="create-ppp-object" class="level4" data-number="5.2.0.1">
<h4 data-number="5.2.0.1" class="anchored" data-anchor-id="create-ppp-object"><span class="header-section-number">5.2.0.1</span> Create ppp object</h4>
<p>The code chunk below select only the necessary fields (<code>month_no</code>) from the <code>bmr_acc</code> sf data frame and conver to ppp object using <code>as.ppp()</code>. This is because <code>as.ppp()</code> function only requires the mark field and geometry field from sf data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>acc_month_ppp <span class="ot">=</span> bmr_acc <span class="sc">|&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month_no) <span class="sc">|&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.ppp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we include owin object and check if the output <code>acc_month_owin</code> is in the correct object class. We can see the object is already in ppp class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>acc_month_owin <span class="ot">&lt;-</span> acc_month_ppp[acc_owin]</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_month_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern:  3283 points
Average intensity 6.70773e-07 points per square unit

*Pattern contains duplicated points*

Coordinates are given to 10 decimal places

marks are numeric, of type 'double'
Summary:
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    4.00    7.00    7.05   10.00   12.00 

Window: polygonal boundary
single connected closed polygon with 15150 vertices
enclosing rectangle: [611104.4, 712440.5] x [1484413.7, 1579076.3] units
                     (101300 x 94660 units)
Window area = 4894350000 square units
Fraction of frame area: 0.51</code></pre>
</div>
</div>
<p><code>plot()</code> of base R is used to plot the owin object. The output map shows proper province boundaries and marked points of 12 months.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(acc_month_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compute-spatio-temporal-kde" class="level4" data-number="5.2.0.2">
<h4 data-number="5.2.0.2" class="anchored" data-anchor-id="compute-spatio-temporal-kde"><span class="header-section-number">5.2.0.2</span> Compute Spatio-temporal KDE</h4>
<p>Next, <code>spattemp.density()</code> of <strong>sparr</strong> package is used to compute the STKDE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>acc_month_stkde <span class="ot">&lt;-</span> <span class="fu">spattemp.density</span>(acc_month_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating trivariate smooth...Done.
Edge-correcting...Done.
Conditioning on time...Done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_month_stkde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal Kernel Density Estimate

Bandwidths
  h = 3953.323 (spatial)
  lambda = 0.0301 (temporal)

No. of observations
  3283 

Spatial bound
  Type: polygonal
  2D enclosure: [611104.4, 712440.5] x [1484414, 1579076]

Temporal bound
  [1, 12]

Evaluation
  128 x 128 x 12 trivariate lattice
  Density range: [3.272962e-25, 3.865178e-09]</code></pre>
</div>
</div>
<p><code>plot()</code> of base R is used to plot the spatio-temporal KDE between January 2022 - December 2022 using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>tims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> tims){ </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(acc_month_stkde, i,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">override.par=</span><span class="cn">FALSE</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">fix.range=</span><span class="cn">TRUE</span>, </span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"KDE at month"</span>,i))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can observe the highest density in December in Bangkok and Samut Sakhon area, followed by January. From August to November, the density spread more equally across the 4 provinces.</p>
<p>Thailand experiences 3 main seasons:</p>
<ul>
<li><p>The wet season from May to October</p></li>
<li><p>The cool season from November to February</p></li>
<li><p>The hot season from March to May</p></li>
</ul>
<p>We can observe that the hot and wet season have lower STKDE compared versus cool season (especially in January and December). This can be partly contributed to cool season being high season for travelling in those areas with high density.</p>
</section>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<section id="create-ppp-object-1" class="level4" data-number="5.2.0.3">
<h4 data-number="5.2.0.3" class="anchored" data-anchor-id="create-ppp-object-1"><span class="header-section-number">5.2.0.3</span> Create ppp object</h4>
<p>The code chunk below select only the necessary fields (<code>dayofweek</code>) from the <code>bmr_acc</code> sf data frame and conver to ppp object using <code>as.ppp()</code>. This is because <code>as.ppp()</code> function only requires the mark field and geometry field from sf data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>acc_day_ppp <span class="ot">&lt;-</span> bmr_acc <span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dayofweek) <span class="sc">|&gt;</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.ppp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we include owin object and check if the output <code>acc_day_owin</code> is in the correct object class. We can see the object is already in ppp class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>acc_day_owin <span class="ot">&lt;-</span> acc_day_ppp[acc_owin]</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_day_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern:  3283 points
Average intensity 6.70773e-07 points per square unit

*Pattern contains duplicated points*

Coordinates are given to 10 decimal places

marks are numeric, of type 'double'
Summary:
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   2.000   4.000   4.077   6.000   7.000 

Window: polygonal boundary
single connected closed polygon with 15150 vertices
enclosing rectangle: [611104.4, 712440.5] x [1484413.7, 1579076.3] units
                     (101300 x 94660 units)
Window area = 4894350000 square units
Fraction of frame area: 0.51</code></pre>
</div>
</div>
<p><code>plot()</code> of base R is used to plot the owin object. The output map shows proper province boundaries and marked points of 7 days in a week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(acc_day_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compute-spatio-temporal-kde-1" class="level4" data-number="5.2.0.4">
<h4 data-number="5.2.0.4" class="anchored" data-anchor-id="compute-spatio-temporal-kde-1"><span class="header-section-number">5.2.0.4</span> Compute Spatio-temporal KDE</h4>
<p>Next, <code>spattemp.density()</code> of <strong>sparr</strong> package is used to compute the STKDE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>acc_day_stkde <span class="ot">&lt;-</span> <span class="fu">spattemp.density</span>(acc_day_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating trivariate smooth...Done.
Edge-correcting...Done.
Conditioning on time...Done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_day_stkde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal Kernel Density Estimate

Bandwidths
  h = 3953.323 (spatial)
  lambda = 0.013 (temporal)

No. of observations
  3283 

Spatial bound
  Type: polygonal
  2D enclosure: [611104.4, 712440.5] x [1484414, 1579076]

Temporal bound
  [1, 7]

Evaluation
  128 x 128 x 7 trivariate lattice
  Density range: [1.848561e-24, 1.301055e-08]</code></pre>
</div>
</div>
<p><code>plot()</code> of base R is used to plot the spatio-temporal KDE for each day in a week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>tims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>wdays <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Monday"</span>, <span class="st">"Tuesday"</span>, <span class="st">"Wednesday"</span>, <span class="st">"Thursday"</span>, <span class="st">"Friday"</span>, <span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> tims){ </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(acc_day_stkde, i,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">override.par=</span><span class="cn">FALSE</span>,</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">fix.range=</span><span class="cn">TRUE</span>, </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"KDE on"</span>,wdays[i]))</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above maps show that all 4 provinces have areas with high density on Monday (highest in Bangkok), follow by Sunday where high density areas are more spread out. The density is lower during middle of the week (Tuesday to Thursday) and starts to pick up towards the weekend (Friday to Sunday).</p>
</section>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<section id="create-ppp-object-2" class="level4" data-number="5.2.0.5">
<h4 data-number="5.2.0.5" class="anchored" data-anchor-id="create-ppp-object-2"><span class="header-section-number">5.2.0.5</span> Create ppp object</h4>
<p>The code chunk below select only the necessary fields (<code>hourofday</code>) from the <code>bmr_acc</code> sf data frame and conver to ppp object using <code>as.ppp()</code>. This is because <code>as.ppp()</code> function only requires the mark field and geometry field from sf data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>acc_hr_ppp <span class="ot">&lt;-</span> bmr_acc <span class="sc">|&gt;</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(hourofday) <span class="sc">|&gt;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.ppp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we include owin object and check if the output <code>acc_hr_owin</code> is in the correct object class. We can see the object is already in ppp class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>acc_hr_owin <span class="ot">&lt;-</span> acc_hr_ppp[acc_owin]</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_hr_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marked planar point pattern:  3283 points
Average intensity 6.70773e-07 points per square unit

*Pattern contains duplicated points*

Coordinates are given to 10 decimal places

marks are numeric, of type 'integer'
Summary:
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    0.0     8.0    13.0    12.5    18.0    23.0 

Window: polygonal boundary
single connected closed polygon with 15150 vertices
enclosing rectangle: [611104.4, 712440.5] x [1484413.7, 1579076.3] units
                     (101300 x 94660 units)
Window area = 4894350000 square units
Fraction of frame area: 0.51</code></pre>
</div>
</div>
<p><code>plot()</code> is used to plot the owin object to examine the correctness of the output object.The output map shows proper province boundaries and marked points of 24 hours in a day.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(acc_hr_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compute-spatio-temporal-kde-2" class="level4" data-number="5.2.0.6">
<h4 data-number="5.2.0.6" class="anchored" data-anchor-id="compute-spatio-temporal-kde-2"><span class="header-section-number">5.2.0.6</span> Compute Spatio-temporal KDE</h4>
<p>Next, <code>spattemp.density()</code> of <strong>sparr</strong> package is used to compute the STKDE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>acc_hr_stkde <span class="ot">&lt;-</span> <span class="fu">spattemp.density</span>(acc_hr_owin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Calculating trivariate smooth...Done.
Edge-correcting...Done.
Conditioning on time...Done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(acc_hr_stkde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spatiotemporal Kernel Density Estimate

Bandwidths
  h = 3953.323 (spatial)
  lambda = 0.0806 (temporal)

No. of observations
  3283 

Spatial bound
  Type: polygonal
  2D enclosure: [611104.4, 712440.5] x [1484414, 1579076]

Temporal bound
  [0, 23]

Evaluation
  128 x 128 x 24 trivariate lattice
  Density range: [1.091345e-26, 4.371593e-10]</code></pre>
</div>
</div>
<p><code>plot()</code> of base R is used to plot the spatio-temporal KDE of the first half of the day (from 0 AM to 12 PM).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>tims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> tims){ </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(acc_hr_stkde, i,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">override.par=</span><span class="cn">FALSE</span>,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">fix.range=</span><span class="cn">TRUE</span>, </span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"KDE at hour"</span>,i))</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The highest density can be observed at midnight ( around 0 AM) and from 8AM to 11:59AM.</p>
<p>We continue to use <code>plot()</code> of base R to plot the STKDE of the second half of the day.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>tims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">19</span>,<span class="dv">20</span>,<span class="dv">21</span>,<span class="dv">22</span>,<span class="dv">23</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> tims){ </span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(acc_hr_stkde, i,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">override.par=</span><span class="cn">FALSE</span>,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">fix.range=</span><span class="cn">TRUE</span>, </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"KDE at hour"</span>,i))</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For the remainder of the day, high density can be observed during lunch time (12PM - 13PM), in the evening (16PM - 19PM) and late night (22PM -23PM).</p>
</section>
</div>
</div>
</div>
</section>
</section>
<section id="network-spatial-point-patterns-analysis" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Network Spatial Point Patterns Analysis</h1>
<section id="prepare-the-lixels-objects-and-generate-line-centre-points" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="prepare-the-lixels-objects-and-generate-line-centre-points"><span class="header-section-number">6.1</span> Prepare the lixels objects and generate line centre points</h2>
<p>Before computing NKDE, the SpatialLines object needs to be divided into lixels (line pixels) with a specified minimum distance. This can be done using the <code>lixelize_lines()</code> function from the spNetwork package, as shown in the code chunk below.</p>
<p>According to the nearest neighbor distance plotted above, the smallest network distance between 2 accident points is under 100 meters. The lixel length and mindist should be larger than 100 meters to ensure these cases can be captured.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>lixels <span class="ot">&lt;-</span> <span class="fu">lixelize_lines</span>(network, </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">800</span>, </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mindist =</span> <span class="dv">400</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The followings are observed from the above code chunk.</p>
<ul>
<li><p>The length of each lixel (<code>lx_length</code>) is set to 800 meters.</p></li>
<li><p>The minimum length of a lixel (<code>mindist</code>) is set to 400 meters.</p></li>
</ul>
<p>After cutting, if the length of the final lixel is shorter than the minimum distance, it is merged with the previous lixel. If mindist = NULL, then it defaults to maxdist/10. Segments that are already shorter than the minimum distance are left unmodified.</p>
<p>Note: The lixelize_lines.mc() function offers multicore support for this process.</p>
<p>Next, <code>lines_center()</code> of <strong>spNetwork</strong> is used to generate a SpatialPointsDataFrame (i.e.&nbsp;<code>samples</code>) with line centre points as shown in the code chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">lines_center</span>(lixels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These points are located at center of the lixel based on the length of the lixel.</p>
</section>
<section id="perform-nkde" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="perform-nkde"><span class="header-section-number">6.2</span> Perform NKDE</h2>
<p>NKDE is computed using below code chunk, using the following key arguments:</p>
<ul>
<li><p>kernel_name = “quartic”: ensure no negative value returned.</p></li>
<li><p>method = “simple”: for faster calculation given the data size. Since the <code>network</code> contains many intersections, we acknowledge this simple method may overestimate the density at road intersections.</p></li>
<li><p>adaptive = FALSE and bw = 500: use fixed bandwidth of 500 meters</p></li>
<li><p>agg = 30: aggregate accident points within 30 meters of each other</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate NKDE</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>densities <span class="ot">&lt;-</span> <span class="fu">nkde</span>(network, </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">events =</span> bmr_acc,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmr_acc)),</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">samples =</span> samples,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">kernel_name =</span> <span class="st">"quartic"</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">bw =</span> <span class="dv">500</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">adaptive =</span> <span class="cn">FALSE</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">div=</span> <span class="st">"bw"</span>, </span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"simple"</span>, </span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">digits =</span> <span class="dv">1</span>, </span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tol =</span> <span class="dv">1</span>,</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), </span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_depth =</span> <span class="dv">8</span>,</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">agg =</span> <span class="dv">30</span>, </span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sparse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The below code chunk performs the following steps:</p>
<ul>
<li><p>Assign the calculated densities to column <code>density</code> in <code>samples</code> sf data frame and multiply by 1000 to convert to density by km.</p></li>
<li><p>Plot the density value for each lixel centre using multiple functions of <strong>tmap</strong>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>density <span class="ot">&lt;-</span> densities</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rescaling to help the mapping</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>density <span class="ot">&lt;-</span> samples<span class="sc">$</span>density<span class="sc">*</span><span class="dv">1000</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>samples2 <span class="ot">&lt;-</span> samples[<span class="fu">order</span>(samples<span class="sc">$</span>density),]</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>colorRamp <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">name =</span> <span class="st">"Spectral"</span>)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>colorRamp <span class="ot">&lt;-</span> <span class="fu">rev</span>(colorRamp)</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Traffic accident density by km in 2022,"</span>,</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"</span><span class="sc">\n</span><span class="st">within a radius of 500 metres"</span>)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary) <span class="sc">+</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(network) <span class="sc">+</span> </span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(samples2) <span class="sc">+</span> </span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"density"</span>, <span class="at">style =</span> <span class="st">"cont"</span>, <span class="at">palette =</span> colorRamp, <span class="at">n =</span> <span class="dv">5</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside =</span> <span class="cn">TRUE</span>, </span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title =</span> title , <span class="at">main.title.size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see from the above map accidents density is higher across certain roads:</p>
<ul>
<li><p>The vertical road connecting Samut Prakan, Bangkok and Pathum Thani.</p></li>
<li><p>The horizontal roads connecting Samut Sakhon, Bangkok and Samut Prakan. There are some hot spot on the road in Samut Prakan province as well.</p></li>
</ul>
</section>
<section id="network-constrained-g--and-k-function-analysis" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="network-constrained-g--and-k-function-analysis"><span class="header-section-number">6.3</span> Network Constrained G- and K-Function Analysis</h2>
<p>In this section, we perform complete spatial randomness (CSR) test using <code>kfunctions()</code> of spNetwork package. The null hypothesis is defined as:</p>
<p>H0: The observed spatial point events (i.e traffic accidents) are randomly distributed over the street <code>network</code> in the 4 provinces in BMR.</p>
<p>The CSR test assumes a binomial point process, meaning the centres are randomly and independently distributed. If rejected, it indicates the centres are spatially dependent and form nonrandom patterns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>kfun_acc <span class="ot">&lt;-</span> <span class="fu">kfunctions</span>(network, </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>                             bmr_acc,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">start =</span> <span class="dv">0</span>, </span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">end =</span> <span class="dv">1500</span>, </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">step =</span> <span class="dv">100</span>, </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">width =</span> <span class="dv">500</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">agg =</span> <span class="dv">30</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nsim =</span> <span class="dv">29</span>, </span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">resolution =</span> <span class="dv">50</span>,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">verbose =</span> <span class="cn">FALSE</span>, </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">conf_int =</span> <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note</strong>: 9 key arguments used in above code chunk:</p>
<ul>
<li><p>lines: A feature collection of linestrings representing the underlying network. The geometries must be simple Linestrings.</p></li>
<li><p>points: A <code>sf</code> data frame representing points on the network. These points will be snapped on their nearest line.</p></li>
<li><p>start: A double, the start value for evaluating the k and g functions.</p></li>
<li><p>end: A double, the last value for evaluating the k and g functions.</p></li>
<li><p>step: A double, specifying the interval between evaluations of the k and g functions.</p></li>
<li><p>width: The width of each donut for the g-function.</p></li>
<li><p>nsim: An integer for the number of Monte Carlo simulations. Typically, more than 50 simulations are needed for inference.</p></li>
<li><p>resolution: A value to reduce calculation time when simulating random points by splitting edges and selecting vertices.</p></li>
<li><p>conf_int: A double for setting the confidence interval (default is 0.05).</p></li>
</ul>
<p>For more details on these arguments, refer to the spNetwork user guide.</p>
<p>The output of kfunctions() is a list containing:</p>
<ul>
<li><p><code>plotkA</code>: A ggplot2 object representing the k-function values.</p></li>
<li><p><code>plotgA</code>: A ggplot2 object representing the g-function values.</p></li>
<li><p><code>valuesA</code>: A DataFrame containing the data used to generate the plots.</p></li>
</ul>
<p>For example, the ggplot2 object of k-function can be visualized using the following code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>kfun_acc<span class="sc">$</span>plotk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The blue line is the empirical network K-function of traffic accidents in the 4 provinces in BMR. The gray envelop represents the results of the 30 simulations in the confidence interval 2.5% - 97.5%. Since the blue line segment is way above the gray area, we can infer that the accidents are more clustered than what can be expected from a random distribution.</p>
<p>The below code chunk is used to plot the G function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>kfun_acc<span class="sc">$</span>plotg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The G-function also demonstrates a clustered distribution. For distance lower than 1 kilometer, a local maximum is observed between 250 to 350 meters. This is consistent with the observations that certain part of the road networks have significantly higher density compared to others.</p>
</section>
<section id="analyze-accidents-at-high-nkde-lixels" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="analyze-accidents-at-high-nkde-lixels"><span class="header-section-number">6.4</span> Analyze Accidents at high NKDE lixels</h2>
<p>First we assign the calculated NKDE to <code>lixel</code> sf data frame and multiply by 1000 to convert to density per km using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>lixels<span class="sc">$</span>density <span class="ot">=</span> densities<span class="sc">*</span><span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we use <code>summary()</code> to check the quantile distribution of <code>density</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lixels<span class="sc">$</span>density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0000000 0.0000000 0.0000000 0.0009879 0.0000000 0.1394524 </code></pre>
</div>
</div>
<p>In this section, we will focus on accidents happening at lixels with density higher than the mean. This is to understand which factors contribute to those parts of the road with above average accident density.</p>
<p>We remove the geometry column from <code>lixels</code> and create a new data frame <code>lixels_df</code> for easier data frame manipulation later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>lixels_df <span class="ot">=</span> <span class="fu">st_drop_geometry</span>(lixels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The below code chunk performs the following steps:</p>
<ul>
<li><p>Snaps accident points to the nearest lixel within 50 meters using <code>snapPointsToLines2()</code> and return the respective <code>lineID</code> of the closest lixel.</p></li>
<li><p><code>left_join()</code> with lixels_df to bring in the density values and other road attributes.</p></li>
<li><p>Filter for accidents snapped to lixels with density above average.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>snapped_accidents <span class="ot">=</span> <span class="fu">snapPointsToLines2</span>(</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  bmr_acc,</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  lixels,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">idField =</span> <span class="st">"lineID"</span>,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">snap_dist =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lixels_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"nearest_line_id"</span> <span class="ot">=</span> <span class="st">"lineID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(density <span class="sc">&gt;</span> <span class="fl">0.0009879</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="environmental-factors" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="environmental-factors"><span class="header-section-number">6.4.1</span> Environmental Factors</h3>
<p>The environmental factors: road type, weather condition and road condition are visualized using <code>ggplot()</code> as in below code chunks.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Road Type</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Weather Condition</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-3" role="tab" aria-controls="tabset-6-3" aria-selected="false">Road Condition</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by road type and count the number of accidents</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>accidents_by_road_type <span class="ot">&lt;-</span> snapped_accidents <span class="sc">%&gt;%</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(highway) <span class="sc">%&gt;%</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">accident_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column chart</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_road_type, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(highway, <span class="sc">-</span>accident_count), <span class="at">y =</span> accident_count)) <span class="sc">+</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> accident_count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span>  <span class="co"># Add data labels</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Road Type"</span>, </span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Road Type"</span>, </span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows more than half of the accidents in 2022 happened on the motorway.</p>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by condition and count the number of accidents</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>accidents_by_weather <span class="ot">&lt;-</span> snapped_accidents <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(weather_rd) <span class="sc">%&gt;%</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">accident_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column chart</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_weather, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(weather_rd, <span class="sc">-</span>accident_count), <span class="at">y =</span> accident_count)) <span class="sc">+</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> accident_count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span>  <span class="co"># Add data labels</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Weather Condition"</span>, </span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Weather Condition"</span>, </span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above plot shows that 90% of the accidents in 2022 happened under clear weather.</p>
</div>
<div id="tabset-6-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by condition and count the number of accidents</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>accidents_by_road <span class="ot">&lt;-</span> snapped_accidents <span class="sc">%&gt;%</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(road_rd) <span class="sc">%&gt;%</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">accident_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column chart</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_road, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(road_rd, <span class="sc">-</span>accident_count), <span class="at">y =</span> accident_count)) <span class="sc">+</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> accident_count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span>  <span class="co"># Add data labels</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Road Condition"</span>, </span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Road Condition"</span>, </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The chart shows that 72.4% of the accidents happened on straight road with no slope.</p>
</div>
</div>
</div>
</section>
<section id="behavioural-factors" class="level3" data-number="6.4.2">
<h3 data-number="6.4.2" class="anchored" data-anchor-id="behavioural-factors"><span class="header-section-number">6.4.2</span> Behavioural Factors</h3>
<p>The behavioral factors from presumed cause are visualized using <code>ggplot()</code> as in below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by condition and count the number of accidents</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>accidents_by_cause <span class="ot">&lt;-</span> snapped_accidents <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(presumed_cause_rd) <span class="sc">%&gt;%</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">accident_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column chart</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(accidents_by_cause, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(presumed_cause_rd, <span class="sc">-</span>accident_count), <span class="at">y =</span> accident_count)) <span class="sc">+</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"skyblue"</span>) <span class="sc">+</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> accident_count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span>  <span class="co"># Add data labels</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Number of Accidents by Presumed Cause"</span>, </span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Presumed Cause"</span>, </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The chart shows 72% of accidents was due to speeding.</p>
</section>
</section>
</section>
<section id="temporal-network-spatial-point-pattern-analysis" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Temporal Network Spatial Point Pattern Analysis</h1>
<section id="temporal-dimension" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="temporal-dimension"><span class="header-section-number">7.1</span> Temporal Dimension</h2>
<p>First we derive the start of each month for year 2022 to use as label for the later maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="st">"2022/01/01"</span>, <span class="at">format =</span> <span class="st">"%Y/%m/%d"</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nchar</span>(months)<span class="sc">==</span><span class="dv">1</span>, <span class="fu">paste0</span>(<span class="st">"0"</span>, months), months)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>months_starts_labs <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"2022/"</span>,months,<span class="st">"/01"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(months_starts_labs, <span class="at">format =</span> <span class="st">"%Y/%m/%d"</span>)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">difftime</span>(months_starts_num, start, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(months_starts_num)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>months_starts_labs <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"2022/"</span>, <span class="st">""</span>, months_starts_labs, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we calculate the kernel density values in time for several bandwidths using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">nrow</span>(bmr_acc))</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>samples_t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(bmr_acc<span class="sc">$</span>dayofyear), <span class="dv">1</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>time_kernel_values <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_10 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">10</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_20 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">20</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_30 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">30</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_40 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">40</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_50 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">50</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_60 =</span> <span class="fu">tkde</span>(bmr_acc<span class="sc">$</span>dayofyear, <span class="at">w =</span> w, <span class="at">samples =</span> samples_t, <span class="at">bw =</span> <span class="dv">60</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> samples_t</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>df_time <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(time_kernel_values,<span class="at">id.vars =</span> <span class="st">"time"</span>)</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>df_time<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_time<span class="sc">$</span>variable)</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_time) <span class="sc">+</span> </span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> months_starts_num, <span class="at">labels =</span> months_starts_labs) <span class="sc">+</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(variable), <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that a bandwidth between 30 and 40 days can capture the fluctuations and the trend in traffic accidents throughout 2022: the increase in traffic accident during mid of April (Songkran festival), followed by a decrease until Jun, before the number of accidents starts to increase until the end of the year.</p>
</section>
<section id="spatial-temporal-bandwidth-selection" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="spatial-temporal-bandwidth-selection"><span class="header-section-number">7.2</span> Spatial Temporal Bandwidth Selection</h2>
<p>The cross validation likelihood of different network and time bandwiths are calculated using <code>bw_tnkde_cv_likelihood_calc()</code> as in below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>cv_scores <span class="ot">&lt;-</span> <span class="fu">bw_tnkde_cv_likelihood_calc</span>(</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">bws_net =</span> <span class="fu">seq</span>(<span class="dv">500</span>,<span class="dv">1000</span>,<span class="dv">100</span>),</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">bws_time =</span> <span class="fu">seq</span>(<span class="dv">20</span>,<span class="dv">60</span>,<span class="dv">10</span>),</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lines =</span> network,</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">events =</span> bmr_acc,</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_field =</span> <span class="st">"dayofyear"</span>,</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmr_acc)),</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel_name =</span> <span class="st">"quartic"</span>,</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"simple"</span>,</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">diggle_correction =</span> <span class="cn">FALSE</span>,</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">study_area =</span> <span class="cn">NULL</span>,</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">8</span>,</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tol =</span> <span class="fl">0.1</span>,</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">agg =</span> <span class="dv">30</span>,</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">sparse=</span><span class="cn">TRUE</span>,</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid_shape=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sub_sample=</span><span class="dv">1</span>,</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>cv_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            20        30        40        50        60
500  -394.7186 -334.0445 -299.0691 -274.7406 -252.7279
600  -374.2905 -313.2305 -277.8549 -254.1699 -232.1701
700  -353.0463 -293.8778 -258.3238 -235.6832 -213.6953
800  -333.0546 -275.9970 -239.6473 -218.0638 -196.2973
900  -316.8013 -261.2312 -222.6306 -201.8828 -182.2077
1000 -300.9982 -251.6730 -213.0711 -192.3536 -172.2757</code></pre>
</div>
</div>
<p>According to this “leave one out cross validation” method, the bandwidths of 1000 metres and 60 days has the lowest cross validation score and are chosen to be the optimal bandwidth for further density calculation.</p>
</section>
<section id="perform-temporal-network-kernel-density-estimate-tnkde" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="perform-temporal-network-kernel-density-estimate-tnkde"><span class="header-section-number">7.3</span> Perform Temporal Network Kernel Density Estimate (TNKDE)</h2>
<p>The TNKDE is calculated using below code chunk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choosing sample in times (every 30 days)</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>sample_time <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(bmr_acc<span class="sc">$</span>dayofyear), <span class="dv">30</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co"># calculating densities</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>tnkde_densities <span class="ot">&lt;-</span> <span class="fu">tnkde</span>(<span class="at">lines =</span> network,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">events =</span> bmr_acc,</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">time_field =</span> <span class="st">"dayofyear"</span>,</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmr_acc)), </span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">samples_loc =</span> samples,</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">samples_time =</span> sample_time, </span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">kernel_name =</span> <span class="st">"quartic"</span>,</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">bw_net =</span> <span class="dv">1000</span>, <span class="at">bw_time =</span> <span class="dv">60</span>,</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"simple"</span>,</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">div =</span> <span class="st">"bw"</span>, <span class="at">max_depth =</span> <span class="dv">8</span>,</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="fl">0.01</span>,</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">agg =</span> <span class="dv">30</span>, <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), </span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose  =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We add the TNKDE of every 30 days to the <code>samples</code> sf data frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_30 <span class="ot">=</span> tnkde_densities[,<span class="dv">2</span>]</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_60 <span class="ot">=</span> tnkde_densities[,<span class="dv">3</span>]</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_90 <span class="ot">=</span> tnkde_densities[,<span class="dv">4</span>]</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_120 <span class="ot">=</span> tnkde_densities[,<span class="dv">5</span>]</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_150 <span class="ot">=</span> tnkde_densities[,<span class="dv">6</span>]</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_180 <span class="ot">=</span> tnkde_densities[,<span class="dv">7</span>]</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_210 <span class="ot">=</span> tnkde_densities[,<span class="dv">8</span>]</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_240 <span class="ot">=</span> tnkde_densities[,<span class="dv">9</span>]</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_270 <span class="ot">=</span> tnkde_densities[,<span class="dv">10</span>]</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_300 <span class="ot">=</span> tnkde_densities[,<span class="dv">11</span>]</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_330 <span class="ot">=</span> tnkde_densities[,<span class="dv">12</span>]</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>tnkde_360 <span class="ot">=</span> tnkde_densities[,<span class="dv">13</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use different functions of <strong>tmap</strong> to plot the map for each sample in time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the last 12 columns' names</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>cols_to_plot <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">colnames</span>(samples), <span class="dv">12</span>)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the map for each column</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(bmr_boundary) <span class="sc">+</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(samples) <span class="sc">+</span> </span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>(<span class="at">col =</span> cols_to_plot, <span class="at">style =</span> <span class="st">"kmeans"</span>, <span class="at">palette =</span> <span class="st">"Reds"</span>,  <span class="at">n=</span><span class="dv">10</span>, <span class="at">size =</span> <span class="fl">0.05</span>) <span class="sc">+</span> </span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.show =</span> <span class="cn">FALSE</span>, </span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> cols_to_plot , <span class="at">title.size =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The value range of the variable "tnkde_90" is less than 1e-9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The value range of the variable "tnkde_120" is less than 1e-9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The value range of the variable "tnkde_210" is less than 1e-9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The value range of the variable "tnkde_360" is less than 1e-9</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Take-home_Ex01_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The location of many of the hotspots stay along the same roads across different points in time:</p>
<ul>
<li><p>Several hotspots detected along the vertical road connecting Samut Prakan, Bangkok and Pathum Thani province. Refer to the maps on TNKDE at 60 days, 150 to 180 days, 240 to 300 days.</p></li>
<li><p>Several hotspots detected along the horizontal road connecting Bangkok and Samut Sakhon province. Refer to the maps on TNKDE at 240 to 330 days.</p></li>
</ul>
</section>
</section>
<section id="conclusions-and-future-improvements" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Conclusions and Future Improvements</h1>
<section id="factors-affecting-traffic-accidents" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="factors-affecting-traffic-accidents"><span class="header-section-number">8.1</span> Factors affecting Traffic Accidents</h2>
<p>The above analysis highlights a few key factors affecting road traffic accidents in the 4 provinces of BMR:</p>
<ul>
<li><p>Environmental factors: do not seem to play an important role as majority of the accidents happened under clear weather (90%) and on straigh road with no slope (72%).</p></li>
<li><p><strong>Driver behaviors</strong>: is an important factor as 72% of the accidents recorded was due to speeding.</p></li>
<li><p><strong>Spatial factor</strong>: Network Constrained G- and K-Function results confirm the clustered distribution of accidents in BMR.</p></li>
</ul>
<p><strong>On Spatial temporal factors</strong></p>
<ul>
<li><p><strong>Month in year</strong>: High STKDE in in December in Bangkok and Samut Sakhon area, followed by January. From August to November, the density spread more equally across the 4 provinces. Cool season (especially in January and December) has the highest density, this can be partly due to this season being high season for tourism in Thailand.</p></li>
<li><p><strong>Day in week</strong>: All 4 provinces have areas with high density on Monday (highest in Bangkok), followed by Sunday where high density areas are more spread out. The density is lower during middle of the week (Tuesday to Thursday) and starts to pick up towards the weekend (Friday to Sunday).</p></li>
<li><p><strong>Hour of day</strong>: The highest density can be observed at late night (22PM to 0 AM of the next day) and from 8AM to 11:59AM. For the remainder of the day, high density can be observed during lunch time (12PM - 13PM) and in the evening (16PM - 19PM).</p></li>
<li><p>The <strong>TNKDE</strong> maps show many of the hotspots stay along the same roads across different points in time: the vertical road connecting Samut Prakan, Bangkok and Pathum Thani province and the horizontal road connecting Bangkok and Samut Sakhon province.</p></li>
</ul>
</section>
<section id="future-improvement" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="future-improvement"><span class="header-section-number">8.2</span> Future Improvement</h2>
<p>As I encountered certain computational capacity constraint given the data size, the below improvements can be done on the analysis of the accidents spatial temporal distribution in BMR:</p>
<ul>
<li><p>As the accidents distribution is clustered, using adaptive bandwith instead of fixed bandwidth for KDE methods may avoid underestimating the density of areas with lower number of accidents.</p></li>
<li><p>User method = “continuous” instead of “simple” since the road network in BMR contains many intersections.</p></li>
<li><p>Use cross validation method for bandwidth selection to allow for a more data-driven approach when selecting bandwidth.</p></li>
<li><p>Increase the number of simulations to calculate network constrained G and K functions for a more comprehensive range of comparison.</p></li>
</ul>
</section>
</section>
<section id="reference" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Reference</h1>
<p>Jeremy Gelb (2024). <a href="https://jeremygelb.github.io/spNetwork/articles/TNKDE.html">Temporal Network Kernel Density Estimate</a></p>
<p>Jeremy Gelb (2024). <a href="https://jeremygelb.github.io/spNetwork/articles/web_vignettes/AdaptiveBW.html">K-nearest neighbour adaptive bandwidth</a></p>
<p>Jeremy Gelb (2024). <a href="https://jeremygelb.github.io/spNetwork/articles/KNetworkFunctions.html">Network k Functions</a></p>
<p>Jeremy Gelb (2024). <a href="https://jeremygelb.github.io/spNetwork/articles/NKDE.html">Network Kernel Density Estimate</a></p>
<p>Tin Seong Kam (2024). <a href="https://r4gdsa.netlify.app/chap06">Spatio-Temporal Point Patterns Analysis</a> From R for Geospatial Data Science and Analytics</p>
<p>Tin Seong Kam (2024). <a href="https://r4gdsa.netlify.app/chap07">Network Constrained Spatial Point Patterns Analysis</a></p>
<p>WikiProject Thailand. <a href="https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification">WikiProject Thailand</a></p>
<p>Wikipedia. <a href="https://en.wikipedia.org/wiki/Bangkok_Metropolitan_Region">Bangkok Metropolitan Region</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>